apiVersion: apps/v1
kind: Deployment
metadata:
    name: sms-api
    namespace: comms
    labels: &smsLabels
        app: sms
        tier: backend
        role: api
        component: sms
spec:
    selector:
        matchLabels: *smsLabels
    replicas: 1
    template:
        metadata:
            labels: *smsLabels
        spec:
            securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 3000
                fsGroup: 2000

            imagePullSecrets:
                - name: docker-hub-registry

            containers:
                -   name: sms-gateway
                    image: garihublimited/sms-gateway:alpha
                    imagePullPolicy: Always
                    readinessProbe:
                        httpGet:
                            path: /health
                            port: 5000
                    ports:
                        - name: http
                          containerPort: 5000
                    env:
                        -   name: FLASK_ENV
                            value: "staging"

                        - name: BETTER_EXCEPTIONS
                          value: '0'

                        -   name: PORT
                            value: "5000"

                        -   name: SMS_API_USERNAME
                            valueFrom:
                                secretKeyRef:
                                    name: sms-config
                                    key: username

                        -   name: SMS_API_TOKEN
                            valueFrom:
                                secretKeyRef:
                                    name: sms-config
                                    key: token

                        -   name: SMS_API_URL
                            valueFrom:
                                secretKeyRef:
                                    name: sms-config
                                    key: apiUrl

                        -   name: BROKER_USER
                            valueFrom:
                                secretKeyRef:
                                    name: sms-broker-credentials
                                    key: user

                        -   name: BROKER_PASSWORD
                            valueFrom:
                                secretKeyRef:
                                    name: sms-broker-credentials
                                    key: password

                        -   name: BROKER_HOST
                            value: 'rabbitmq-svc-headless.broker.svc.cluster.local'

                        -   name: BROKER_PORT
                            value: '5672'

                        -   name: BROKER_URL
                            value: 'amqp://$(BROKER_USER):$(BROKER_PASSWORD)@$(BROKER_HOST):$(BROKER_PORT)//'
                        
                        - name: RESULT_BACKEND_HOST
                          value: redis-svc-headless.cache.svc.cluster.local

                        -   name: RESULT_BACKEND_PORT
                            value: '6379'

                        -   name: RESULT_BACKEND
                            value: 'redis://$(RESULT_BACKEND_HOST):6379'

                        -   name: RESULT_BACKEND_LEADER
                            value: 'redismaster'
